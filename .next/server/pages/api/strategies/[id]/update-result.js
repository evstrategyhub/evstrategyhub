"use strict";(()=>{var t={};t.id=44,t.ids=[44],t.modules={3480:(t,e,r)=>{t.exports=r(5600)},3939:t=>{t.exports=require("@supabase/supabase-js")},5600:t=>{t.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6435:(t,e)=>{Object.defineProperty(e,"M",{enumerable:!0,get:function(){return function t(e,r){return r in e?e[r]:"then"in e&&"function"==typeof e.then?e.then(e=>t(e,r)):"function"==typeof e&&"default"===r?e:void 0}}})},7698:(t,e,r)=>{r.r(e),r.d(e,{config:()=>_,default:()=>l,routeModule:()=>d});var s={};r.r(s),r.d(s,{default:()=>u});var a=r(3480),n=r(8667),o=r(6435);let i=(0,r(3939).createClient)(process.env.NEXT_PUBLIC_SUPABASE_URL,process.env.SUPABASE_SERVICE_ROLE_KEY);async function u(t,e){if("POST"!==t.method)return e.status(405).json({success:!1,error:"Method not allowed"});let{selection_id:r,result:s,is_winner:a}=t.body;if(!r||void 0===s||void 0===a)return e.status(400).json({success:!1,error:"Se requieren selection_id, result y is_winner"});try{let{data:t,error:n}=await i.from("strategy_selections").select("*, betting_strategies!inner(*)").eq("id",r).single();if(n)throw n;if(!t)return e.status(404).json({success:!1,error:"Selecci\xf3n no encontrada"});if("pending"!==t.status)return e.status(400).json({success:!1,error:"Esta selecci\xf3n ya tiene un resultado registrado"});let o=a?t.applied_stake*(parseFloat(t.odd_value)-1):-t.applied_stake,{error:u}=await i.from("strategy_selections").update({result:s,is_winner:a,profit_loss:o,status:a?"won":"lost"}).eq("id",r);if(u)throw u;let l=t.betting_strategies.current_bankroll+o,{error:_}=await i.from("betting_strategies").update({current_bankroll:l,updated_at:new Date().toISOString()}).eq("id",t.strategy_id);if(_)throw _;let{error:d}=await i.from("bankroll_history").insert({strategy_id:t.strategy_id,amount:l,previous_amount:t.betting_strategies.current_bankroll,change_amount:o,change_percentage:o/t.betting_strategies.current_bankroll*100,entry_type:"bet_result",description:`Resultado de apuesta: ${s}`,selection_id:r});if(d)throw d;let{data:c,error:p}=await i.from("strategy_stats").select("*").eq("strategy_id",t.strategy_id).single();if(p)throw p;let g={total_bets:c.total_bets+1,won_bets:a?c.won_bets+1:c.won_bets,lost_bets:a?c.lost_bets:c.lost_bets+1,pending_bets:c.pending_bets>0?c.pending_bets-1:0,total_staked:c.total_staked+t.applied_stake,total_returns:a?c.total_returns+t.applied_stake+o:c.total_returns,total_profit:c.total_profit+o,roi:(c.total_profit+o)/(c.total_staked+t.applied_stake)*100,current_streak:a?c.current_streak+1:0,last_updated:new Date().toISOString()};a&&g.current_streak>c.max_winning_streak&&(g.max_winning_streak=g.current_streak);let{error:f}=await i.from("strategy_stats").update(g).eq("strategy_id",t.strategy_id);if(f)throw f;return e.status(200).json({success:!0,data:{selection_id:r,result:s,is_winner:a,profit_loss:o,new_bankroll:l}})}catch(t){return console.error("Error al actualizar resultado:",t),e.status(500).json({success:!1,error:t.message})}}let l=(0,o.M)(s,"default"),_=(0,o.M)(s,"config"),d=new a.PagesAPIRouteModule({definition:{kind:n.A.PAGES_API,page:"/api/strategies/[id]/update-result",pathname:"/api/strategies/[id]/update-result",bundlePath:"",filename:""},userland:s})},8667:(t,e)=>{Object.defineProperty(e,"A",{enumerable:!0,get:function(){return r}});var r=function(t){return t.PAGES="PAGES",t.PAGES_API="PAGES_API",t.APP_PAGE="APP_PAGE",t.APP_ROUTE="APP_ROUTE",t.IMAGE="IMAGE",t}({})}};var e=require("../../../../webpack-api-runtime.js");e.C(t);var r=e(e.s=7698);module.exports=r})();